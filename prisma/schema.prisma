// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ====================
// 1. GESTION DES ACCÈS ADMIN (MONEY GROUP)
// ====================
model Utilisateur {
  id        String   @id @default(uuid())
  nom       String
  prenom    String
  email     String   @unique
  phone     String   @unique
  password  String   // Toujours haché (Bcrypt)
  role      Role     @default(AGENT)
  createdAt DateTime @default(now())
}

enum Role {
  admin
  agent
}

// ====================
// 2. LE POINT D'ENTRÉE (QUESTIONNAIRE & SCORING)
// ====================
model Prospect {
  id                  String   @id @default(uuid())
  nom                 String
  prenom              String
  pays                String   // Pays du client
  email               String   @unique
  whatsapp            String   @unique
  
  createdAt           DateTime @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  dossier             Dossier?
}

// ====================
// 3. LE SUIVI ADMINISTRATIF DU FINANCEMENT (DOSSIER COMPLET)
// ====================
model Dossier {
  id            String       @id @default(uuid())
  reference     String       @unique
  statut        StatutDossier @default(encours)
  
  // Score et éligibilité
  score         Int          // Score final sur 100
  estEligible   Boolean      // Calculé basé sur le seuil
  
  banque              String   // BSIC, UBA ou autres
  statutProfessionnel StatutProfessionnel // salarié, entrepreneur, entreprise, autres
  
  // Informations de préférences véhicule (de VehiclePreferencesStep)
  typeEnergiePreferre TypeEnergie?     // Électrique, Hybride, Essence, Diesel
  vehiculesSelectionnes Json?          // Liste des véhicules sélectionnés (stocké en JSON)
  
  // Détails du questionnaire (pour analyse approfondie)
  revenusMensuels     Float?   // Revenus mensuels
  dureeEmploi         Int?     // Durée en mois dans l'emploi actuel
  endettementMensuel  Float?   // Montant des dettes mensuelles
  aContentieux        Boolean? // A-t-il des contentieux ?
  autresInfos         Json?    // Autres informations spécifiques au statut
      
  // Catégorie d'éligibilité selon le cahier des charges
  categorieEligibilite categorieEligibilit
  
  // Dates importantes
  dateRendezVous DateTime?   // Date de rendez-vous (si éligible)
  dateCreationDossier DateTime? // Date création dossier administratif
      
  // Préférences véhicule (du VehiclePreferencesStep)
  typeEnergie      TypeEnergie?   // Type d'énergie préféré  
  
  // Références
  prospectId    String       @unique
  prospect      Prospect     @relation(fields: [prospectId], references: [id], onDelete: Cascade)
    
  // Étapes de suivi détaillées (selon cahier des charges)
  dateEnvoiBanque      DateTime? // Date d'envoi à la banque
  dateValidationBanque DateTime? // Date de validation par la banque
  dateImportation      DateTime? // Date début importation
  dateLivraisonPrevue  DateTime? // Date livraison prévue
  dateLivraisonReelle  DateTime? // Date livraison réelle
    
  // Suivi des rendez-vous
  rdvEffectue      Boolean   @default(false) // Rendez-vous effectué ?
  rdvAnnule        Boolean   @default(false) // Rendez-vous annulé ?
  motifAnnulation  String?   // Motif d'annulation
    
  // Relations
  commande      Commande?
  createdAt     DateTime @default(now())
  updatedAt     DateTime     @updatedAt
}

// ====================
// 4. LE PARC AUTOMOBILE DISPONIBLE
// ====================
model Catalogue {
  id          String   @id @default(uuid())
  title       String
  description String
  place       String
  marque      String
  modele      String
  chevaux-vapeur      String
  price        Float
  image       String   // URL de l'image
  typeEnergie TypeEnergie // Type d'énergie du véhicule
  
  // Relations
  commandes   Commande[]
  dossiers    Dossier[] // Dossiers qui ont choisi ce véhicule
}

// ====================
// 5. LA TRANSACTION FINALE
// ====================
model Commande {
  id          String         @id @default(uuid())
  reference   String         @unique
  statut      StatutCommande @default(en_attente)
  
  // Relations
  dossierId   String         @unique
  dossier     Dossier?        @relation(fields: [dossierId], references: [id], onDelete: Cascade)
  
  catalogueId String
  vehicule    Catalogue      @relation(fields: [catalogueId], references: [id])
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime     @updatedAt
}

// ====================
// 6. PARAMÉTRAGE DYNAMIQUE DU SITE (CMS)
// ====================
model SettingsOfSite {
  id                Int      @id @default(1) // Un seul enregistrement (Singleton)
  nameWebsite       String   @default("EasyCar")
  contactEmail      String
  adresse            String
  whatsappContact   String   // Numéro WhatsApp pour support
   
  createdAt     DateTime @default(now())
  updatedAt     DateTime     @updatedAt
}

// ====================
// ENUMS POUR LA SÉCURITÉ DES DONNÉES
// ====================
enum StatutDossier {
  encours
  valide
  rejete
  en_importation
  livraision_programmee
  livraison_reelle
  remboursement_programme
  cloture
}

enum StatutCommande {
  en_attente
  en_preparation
  en_expedition
  livre
}

enum StatutProfessionnel {
  SALARIE
  ENTREPRENEUR
  ENTREPRISE
  AUTRES
}

enum CategorieEligibilite {
  ELIGIBLE_PRIORITAIRE    // ≥ 75 : Éligible prioritaire
  ELIGIBLE_SOUS_CONDITIONS // 60–74 : Éligible sous conditions
  NON_ELIGIBLE            // < 60 : Non éligible
}

enum TypeEnergie {
  ELECTRIQUE
  HYBRIDE
  ESSENCE
  DIESEL
}